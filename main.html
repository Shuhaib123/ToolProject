<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Goroutine Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            /* A very light grey, almost white */
        }

        .step-card {
            transition: all 0.3s ease-in-out;
            border: 1px solid #e2e8f0;
        }

        .step-card.active {
            border-color: #3b82f6;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.2);
        }

        .step-card.completed {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }

        .step-number {
            background-color: #e2e8f0;
            color: #475569;
        }

        .step-card.completed .step-number {
            background-color: #22c55e;
            color: white;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        .code-display {
            background-color: #1e293b;
            color: #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 500px;
            max-height: 70vh;
        }
    </style>
</head>

<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Go Concurrency Visualizer</h1>
            <img src="logo.png" alt="Go Concurrency Visualizer Logo"
                class="mx-auto my-4 w-24 h-24 rounded-full border-4 border-yellow-300 shadow-lg" />
            <p class="mt-4 text-lg text-slate-600">A tool to understand Goroutine and Channel interactions by
                visualizing trace data.</p>
        </header>

        <main>
            <!-- Floating Help Icon Button -->
            <button id="help-btn"
                class="fixed top-6 left-6 z-50 w-12 h-12 flex items-center justify-center rounded-full bg-yellow-300 hover:bg-yellow-400 shadow-lg text-2xl focus:outline-none"
                title="Help">
                <span aria-label="Help" role="img">ðŸ˜Š</span>
            </button>
            <!-- Help Banner -->
            <div id="help-banner"
                class="fixed top-0 left-0 right-0 mx-auto mt-6 max-w-xl w-full bg-white border border-yellow-300 shadow-lg rounded-lg z-50 p-6 flex flex-col items-start transition-all duration-300 hidden"
                style="max-height: 60vh; overflow-y: auto;">
                <button id="close-help"
                    class="absolute top-2 right-4 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                <h2 class="text-2xl font-semibold mb-3 text-slate-800">App Overview & Button Guide</h2>
                <p class="text-slate-700 mb-4">
                    <strong>Go Concurrency Visualizer</strong> helps you understand how goroutines and channels interact
                    in your Go programs. The app guides you through a step-by-step process to instrument, trace,
                    process, and visualize your code's concurrency.
                </p>
                <ul class="list-disc pl-5 space-y-2 text-slate-600">
                    <li><strong>Import Go Code:</strong> Paste or upload your Go code to start the workflow.</li>
                    <li><strong>Generate Code Wrapper:</strong> Automatically wraps your code with tracing logic to
                        enable runtime analysis.</li>
                    <li><strong>GTrace:</strong> Runs your instrumented code to produce a trace file.</li>
                    <li><strong>Generate JSON File:</strong> Processes the trace file into a structured JSON format for
                        visualization.</li>
                    <li><strong>Generate Graph:</strong> Visualizes the concurrency structure of your code as an
                        interactive graph.</li>
                </ul>
            </div>

            <!-- Horizontal Button Row -->
            <div class="flex flex-wrap gap-4 justify-center mb-8">
                <button id="import-go-code"
                    class="px-6 py-4 text-lg font-semibold rounded-lg shadow bg-blue-500 hover:bg-blue-600 text-white">Import
                    Go Code</button>
                <button id="generate-code-wrapper"
                    class="px-6 py-4 text-lg font-semibold rounded-lg shadow bg-green-400 hover:bg-green-500 text-gray-900 btn-disabled"
                    disabled>Generate Code Wrapper</button>
                <button id="gtrace"
                    class="px-6 py-4 text-lg font-semibold rounded-lg shadow bg-yellow-300 hover:bg-yellow-400 text-gray-900 btn-disabled"
                    disabled>GTrace</button>
                <button id="generate-json-file"
                    class="px-6 py-4 text-lg font-semibold rounded-lg shadow bg-red-400 hover:bg-red-500 text-white btn-disabled"
                    disabled>Generate JSON File</button>
                <button id="generate-graph"
                    class="px-6 py-4 text-lg font-semibold rounded-lg shadow bg-gray-800 hover:bg-gray-900 text-white btn-disabled"
                    disabled>Generate Graph</button>
            </div>

            <!-- File input and Load from File button -->
            <input type="file" id="file-input" class="hidden" accept=".go">
            <button id="load-file-btn"
                class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-md mt-2 mb-4">Load
                from File</button>

            <!-- Step Cards for workflow visualization -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div id="step-1" class="step-card bg-white p-5 rounded-lg shadow-sm">
                    <div class="flex items-center mb-3">
                        <span
                            class="step-number h-8 w-8 rounded-full flex items-center justify-center font-bold text-sm mr-3">1</span>
                        <h3 class="text-lg font-semibold text-slate-700">Import Code</h3>
                    </div>
                </div>
                <div id="step-2" class="step-card bg-white p-5 rounded-lg shadow-sm">
                    <div class="flex items-center mb-3">
                        <span
                            class="step-number h-8 w-8 rounded-full flex items-center justify-center font-bold text-sm mr-3">2</span>
                        <h3 class="text-lg font-semibold text-slate-700">Generate Wrapper</h3>
                    </div>
                </div>
                <div id="step-3" class="step-card bg-white p-5 rounded-lg shadow-sm">
                    <div class="flex items-center mb-3">
                        <span
                            class="step-number h-8 w-8 rounded-full flex items-center justify-center font-bold text-sm mr-3">3</span>
                        <h3 class="text-lg font-semibold text-slate-700">GTrace</h3>
                    </div>
                </div>
                <div id="step-4" class="step-card bg-white p-5 rounded-lg shadow-sm">
                    <div class="flex items-center mb-3">
                        <span
                            class="step-number h-8 w-8 rounded-full flex items-center justify-center font-bold text-sm mr-3">4</span>
                        <h3 class="text-lg font-semibold text-slate-700">Generate JSON</h3>
                    </div>
                </div>
                <div id="step-5" class="step-card bg-white p-5 rounded-lg shadow-sm">
                    <div class="flex items-center mb-3">
                        <span
                            class="step-number h-8 w-8 rounded-full flex items-center justify-center font-bold text-sm mr-3">5</span>
                        <h3 class="text-lg font-semibold text-slate-700">Visualize Graph</h3>
                    </div>
                </div>
            </div>

            <!-- Content Display Area -->
            <div id="output-container" class="bg-white p-6 rounded-lg shadow-md min-h-[400px] border border-slate-200">
                <div id="welcome-message">
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">Welcome!</h3>
                    <p class="text-slate-600">Start by pasting your Go code in the text area below or loading it from a
                        file. The results of each step will appear here.</p>
                </div>
                <textarea id="code-input"
                    class="w-full h-96 p-4 border border-slate-300 rounded-md mt-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Paste your Go code here..."></textarea>
                <div id="display-area" class="hidden">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const importCodeBtn = document.getElementById('import-go-code');
        const loadFileBtn = document.getElementById('load-file-btn');
        const fileInput = document.getElementById('file-input');
        const generateWrapperBtn = document.getElementById('generate-code-wrapper');
        const gtraceBtn = document.getElementById('gtrace');
        const generateJsonBtn = document.getElementById('generate-json-file');
        const generateGraphBtn = document.getElementById('generate-graph');

        const stepCards = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3'),
            4: document.getElementById('step-4'),
            5: document.getElementById('step-5'),
        };

        const codeInput = document.getElementById('code-input');
        const outputContainer = document.getElementById('output-container');
        const welcomeMessage = document.getElementById('welcome-message');
        const displayArea = document.getElementById('display-area');

        let graphChart = null;

        const appState = {
            originalCode: '',
            wrappedCode: '',
            traceData: null,
        };

        function enableButton(button) {
            button.disabled = false;
            button.classList.remove('btn-disabled');
        }

        function disableButton(button) {
            button.disabled = true;
            button.classList.add('btn-disabled');
        }

        function updateStepCard(card, state) {
            card.classList.remove('active', 'completed');
            if (state === 'completed') {
                card.classList.add('completed');
            } else if (state === 'active') {
                card.classList.add('active');
            }
        }

        function showOutput(title, content) {
            welcomeMessage.style.display = 'none';
            codeInput.style.display = 'none';
            displayArea.style.display = 'block';
            displayArea.innerHTML =
                '<h3 class="text-xl font-semibold text-slate-700 mb-4">' + title + '</h3>' +
                content;
        }

        loadFileBtn.addEventListener('click', function () {
            fileInput.click();
        });

        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    codeInput.value = e.target.result;
                };
                reader.readAsText(file);
            }
        });

        importCodeBtn.addEventListener('click', function () {
            const userCode = codeInput.value.trim();
            if (userCode === '') {
                alert('Please paste your Go code or load a file first.');
                return;
            }
            appState.originalCode = userCode;
            var content = '<pre class="code-display p-4 rounded-md">' +
                appState.originalCode.replace(/</g, "&lt;") +
                '</pre>';
            showOutput('Step 1: Imported Go Code', content);
            updateStepCard(stepCards[1], 'completed');
            updateStepCard(stepCards[2], 'active');
            enableButton(generateWrapperBtn);
        });

        generateWrapperBtn.addEventListener('click', function () {
            let code = appState.originalCode;
            const packageMatch = code.match(/^\s*package\s+\w+/m);
            const packageLine = packageMatch ? packageMatch[0] : 'package main';
            let importBlock = '';
            let importBlockMatch = code.match(/import\s*(\([\s\S]*?\)|"[^"]+")/m);
            if (importBlockMatch) {
                importBlock = importBlockMatch[0];
                code = code.replace(importBlock, '');
            }
            const requiredImports = ['"log"', '"os"', '"runtime/trace"'];
            let importLines = [];
            if (importBlock) {
                let inner = importBlock.replace(/^import\s*/, '').trim();
                if (inner.startsWith('(')) {
                    inner = inner.slice(1, -1);
                    importLines = inner.split(/\r?\n/).map(function (l) { return l.trim(); }).filter(function (l) { return l; });
                } else {
                    importLines = [inner.replace(/"/g, '"')];
                }
            }
            requiredImports.forEach(function (imp) {
                if (importLines.indexOf(imp) === -1) importLines.push(imp);
            });
            let newImportBlock = '';
            if (importLines.length === 1) {
                newImportBlock = 'import ' + importLines[0];
            } else {
                newImportBlock = 'import (\n' + importLines.map(function (l) { return '    ' + l; }).join('\n') + '\n)';
            }
            let mainRenamed = false;
            code = code.replace(/func\s+main\s*\(\s*\)\s*{/, function (match) {
                mainRenamed = true;
                return 'func originalMain() {';
            });
            if (!mainRenamed) {
                alert("Could not find a 'func main()' in your code. Please provide a complete, runnable Go program.");
                return;
            }
            code = code.replace(/^\s*package\s+\w+\s*/m, '');
            const traceMain = "// This function is the new entry point that starts tracing.\nfunc main() {\n    // Create the trace.out file.\n    f, err := os.Create(\"trace.out\")\n    if err != nil {\n        log.Fatalf(\"failed to create trace output file: %v\", err)\n    }\n    defer f.Close()\n\n    // Start the trace.\n    if err := trace.Start(f); err != nil {\n        log.Fatalf(\"failed to start trace: %v\", err)\n    }\n    defer trace.Stop()\n\n    // Now, call the user's original main function.\n    originalMain()\n}";
            appState.wrappedCode = packageLine + '\n\n' + newImportBlock + '\n\n' + traceMain + '\n\n' + code.trim();
            var content = '<pre class="code-display p-4 rounded-md">' +
                appState.wrappedCode.replace(/</g, "&lt;").replace(/>/g, "&gt;") +
                '</pre>';
            showOutput('Step 2: Generated Wrapper Code', content);
            updateStepCard(stepCards[2], 'completed');
            updateStepCard(stepCards[3], 'active');
            enableButton(gtraceBtn);
        });

        gtraceBtn.addEventListener('click', async function () {
            var content =
                '<p class="text-slate-600">Running your code and collecting trace...</p>' +
                '<div class="mt-4 bg-slate-100 p-4 rounded-md">' +
                '<p class="font-mono text-sm">&gt; go run [your code]</p>' +
                '<p id="trace-status" class="font-mono text-sm text-slate-500 mt-2">Running...</p>' +
                '</div>';
            showOutput('Step 3: Running Trace', content);
            const traceStatus = document.getElementById('trace-status');

            try {
                const response = await fetch('http://localhost:8080/trace', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: appState.wrappedCode
                });

                if (!response.ok) {
                    let errorMsg = 'Backend error: ' + response.status;
                    try {
                        const errorData = await response.json();
                        errorMsg = 'Error: ' + (errorData.error || 'Unknown') + '\n\nGo Output:\n' + (errorData.go_run_output || 'N/A');
                    } catch (e) {
                        errorMsg = 'Backend error: ' + response.status + ' ' + response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                appState.traceData = convertTraceToGraph(data);
                traceStatus.textContent = "Execution complete. Trace data received.";
                traceStatus.classList.remove('text-slate-500');
                traceStatus.classList.add('text-green-600');
                updateStepCard(stepCards[3], 'completed');
                updateStepCard(stepCards[4], 'active');
                enableButton(generateJsonBtn);

            } catch (err) {
                traceStatus.textContent = err.message;
                traceStatus.classList.remove('text-slate-500');
                traceStatus.classList.add('text-red-600');
            }
        });

        function convertTraceToGraph(data) {
            const trace = data.trace;
            if (!Array.isArray(trace)) {
                return { nodes: [], edges: [] };
            }
            const nodes = [];
            const edges = [];
            const goroutineMap = {};

            goroutineMap[1] = { id: 1, type: "goroutine", label: "goroutine 1 (main)", state: "running" };

            trace.forEach(ev => {
                if (ev.Event === "GoCreate") {
                    const parentId = ev.G;
                    const childId = ev.Args[0];
                    if (!goroutineMap[parentId]) {
                        goroutineMap[parentId] = { id: parentId, type: "goroutine", label: `goroutine ${parentId}`, state: "created" };
                    }
                    if (!goroutineMap[childId]) {
                        goroutineMap[childId] = { id: childId, type: "goroutine", label: `goroutine ${childId}`, state: "created" };
                    }
                    edges.push({ from: parentId, to: childId });
                } else if (ev.Event === "GoStart") {
                    const id = ev.G;
                    if (goroutineMap[id]) goroutineMap[id].state = "running";
                } else if (ev.Event === "GoEnd") {
                    const id = ev.G;
                    if (goroutineMap[id]) goroutineMap[id].state = "finished";
                }
            });
            Object.values(goroutineMap).forEach(n => nodes.push(n));
            return { nodes, edges };
        }

        generateJsonBtn.addEventListener('click', function () {
            if (!appState.traceData) {
                alert('No trace data available. Please run GTrace first.');
                return;
            }
            var content =
                '<p class="text-slate-600">Trace file parsed and processed from backend.</p>' +
                '<div class="mt-4 bg-green-100 p-4 rounded-md border border-green-300">' +
                '<p class="font-semibold text-green-800">Success!</p>' +
                '<p class="text-green-700">The trace data has been parsed into a JSON format ready for visualization.</p>' +
                '</div>' +
                '<h4 class="font-semibold mt-4 mb-2">Generated JSON Data:</h4>' +
                '<pre class="code-display p-4 rounded-md">' + JSON.stringify(appState.traceData, null, 2) + '</pre>';
            showOutput('Step 4: Processed Trace Data', content);
            updateStepCard(stepCards[4], 'completed');
            updateStepCard(stepCards[5], 'active');
            enableButton(generateGraphBtn);
        });

        generateGraphBtn.addEventListener('click', function () {
            var content =
                '<p class="text-slate-600 mb-4">' +
                'This graph visualizes the relationships between Goroutines. Hover over any node to see more details.' +
                '</p>' +
                '<div class="chart-container">' +
                '<canvas id="graph-canvas"></canvas>' +
                '</div>';
            showOutput('Step 5: Concurrency Graph Visualization', content);
            drawGraph();
            updateStepCard(stepCards[5], 'completed');
            disableButton(generateGraphBtn);
        });

        function drawGraph() {
            const ctx = document.getElementById('graph-canvas').getContext('2d');
            if (graphChart) {
                graphChart.destroy();
            }

            const positionedNodes = [];
            const nodePositions = {};
            appState.traceData.nodes.forEach((node, index) => {
                const angle = (index / appState.traceData.nodes.length) * 2 * Math.PI;
                const x = 5 + Math.cos(angle) * 4;
                const y = 5 + Math.sin(angle) * 4;
                nodePositions[node.id] = { x, y };

                let color;
                switch (node.state) {
                    case 'running': color = 'rgba(34, 197, 94, 0.8)'; break;
                    case 'finished': color = 'rgba(107, 114, 128, 0.8)'; break;
                    default: color = 'rgba(59, 130, 246, 0.8)';
                }

                positionedNodes.push({
                    x: x,
                    y: y,
                    label: node.label,
                    id: node.id,
                    backgroundColor: color,
                    borderColor: color.replace('0.8', '1'),
                    radius: 15,
                });
            });

            const linePlugin = {
                id: 'edgeLines',
                afterDraw: function (chart) {
                    const ctx = chart.ctx;
                    ctx.save();
                    appState.traceData.edges.forEach(edge => {
                        const fromPos = nodePositions[edge.from];
                        const toPos = nodePositions[edge.to];

                        if (fromPos && toPos) {
                            const fromNode = chart.getDatasetMeta(0).data.find(p => p.$context.raw.id === edge.from);
                            const toNode = chart.getDatasetMeta(0).data.find(p => p.$context.raw.id === edge.to);

                            if (fromNode && toNode) {
                                ctx.beginPath();
                                ctx.moveTo(fromNode.x, fromNode.y);
                                ctx.lineTo(toNode.x, toNode.y);
                                ctx.lineWidth = 2;
                                ctx.strokeStyle = 'rgba(100, 116, 139, 0.5)';
                                ctx.stroke();
                                const headlen = 10;
                                const angle = Math.atan2(toNode.y - fromNode.y, toNode.x - fromNode.x);
                                ctx.beginPath();
                                ctx.moveTo(toNode.x, toNode.y);
                                ctx.lineTo(toNode.x - headlen * Math.cos(angle - Math.PI / 6), toNode.y - headlen * Math.sin(angle - Math.PI / 6));
                                ctx.lineTo(toNode.x - headlen * Math.cos(angle + Math.PI / 6), toNode.y - headlen * Math.sin(angle + Math.PI / 6));
                                ctx.closePath();
                                ctx.fillStyle = 'rgba(100, 116, 139, 0.5)';
                                ctx.fill();
                            }
                        }
                    });
                    ctx.restore();
                }
            };

            graphChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Goroutines',
                        data: positionedNodes,
                        pointRadius: (context) => context.raw.radius,
                        pointHoverRadius: (context) => context.raw.radius + 5,
                        backgroundColor: positionedNodes.map(p => p.backgroundColor),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.raw.label || '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    layout: { padding: 20 }
                },
                plugins: [linePlugin]
            });
        }

        const helpBtn = document.getElementById('help-btn');
        const helpBanner = document.getElementById('help-banner');
        const closeHelp = document.getElementById('close-help');
        helpBtn.addEventListener('click', () => helpBanner.classList.remove('hidden'));
        closeHelp.addEventListener('click', () => helpBanner.classList.add('hidden'));
        helpBanner.addEventListener('click', (e) => { if (e.target === helpBanner) helpBanner.classList.add('hidden'); });

    </script>
    <footer class="w-full text-center py-4 bg-slate-100 text-slate-600 text-sm mt-8">
        @Shuhaib Ansari || Go Concurrency Visualizer || 2025
    </footer>
</body>

</html>